<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHAT & FIT - Fitness & Nutrition Logger</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- SF Pro Display Font -->
    <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/sf-pro-display">

    <style>
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            scroll-behavior: smooth;
            background-color: #f5f5f7;
            -webkit-font-smoothing: antialiased;
            padding-bottom: env(safe-area-inset-bottom);
            color: #1d1d1f;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 1rem;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        .nav-btn, .dash-nav-btn {
            padding: 0.75rem 1.25rem;
            border-radius: 1rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            font-size: 0.9375rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .nav-btn.active, .dash-nav-btn.active {
            color: #007AFF;
            background-color: rgba(0, 122, 255, 0.1);
            border-color: rgba(0, 122, 255, 0.2);
        }
        .nav-btn:not(.active), .dash-nav-btn:not(.active) {
            color: #86868b;
        }
        .nav-btn:not(.active):hover, .dash-nav-btn:not(.active):hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        #dashboard-nav-btn {
            border: 1px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        #dashboard-nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .fade-in { 
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(8px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        /* Input styles */
        input, select, textarea {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            -webkit-appearance: none;
            appearance: none;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            outline: none;
            transform: translateY(-1px);
        }
        
        /* Button styles */
        button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            border-radius: 1rem;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        
        /* Stats card styles */
        .stats-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1.25rem;
        }
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        /* Progress bar styles */
        .progress-bar {
            height: 0.5rem;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #5856D6);
            border-radius: 1rem;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* List item styles */
        .list-item {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
        }
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* Header styles */
        header {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .container {
                padding: 1rem;
                max-width: 100%;
            }
            .card {
                padding: 1.25rem;
                margin: 0 0 1rem 0;
                border-radius: 1rem;
            }
            .stats-card {
                padding: 1rem;
            }
            .nav-btn, .dash-nav-btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                min-width: 80px;
                text-align: center;
            }
            input, select, textarea {
                padding: 0.75rem;
                font-size: 16px;
            }
            .grid {
                gap: 1rem;
            }
            #app-container {
                padding: 1rem;
            }
            header {
                margin: 0 0 1.5rem 0;
                padding: 1.25rem;
                border-radius: 0;
            }
            h1 {
                font-size: 1.75rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            h3 {
                font-size: 1.25rem;
            }
            .list-item {
                padding: 0.875rem;
            }
            .progress-bar {
                height: 0.375rem;
            }
            #workout-list, #food-list {
                max-height: calc(100vh - 400px);
            }
            .number-control-btn {
                padding: 0.5rem;
            }
            .stats-card {
                padding: 0.875rem;
            }
            .stats-card p:last-child {
                font-size: 1.5rem;
            }
        }

        /* Safe area insets for modern mobile browsers */
        @supports (padding: max(0px)) {
            body {
                padding-left: min(0vmin, env(safe-area-inset-left));
                padding-right: min(0vmin, env(safe-area-inset-right));
                padding-bottom: min(0vmin, env(safe-area-inset-bottom));
            }
            .container {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Touch device optimizations */
        @media (hover: none) {
            .card:hover, .stats-card:hover, .list-item:hover {
                transform: none;
                box-shadow: none;
            }
            .nav-btn:hover, .dash-nav-btn:hover, button:hover {
                transform: none;
            }
            .nav-btn:active, .dash-nav-btn:active, button:active {
                opacity: 0.7;
            }
        }

        /* Prevent text size adjustment on orientation change */
        html {
            -webkit-text-size-adjust: 100%;
        }

        /* Improve tap targets */
        button, .nav-btn, .dash-nav-btn, input[type="button"], input[type="submit"] {
            min-height: 44px;
            min-width: 44px;
        }

        /* Improve form elements on mobile */
        @media (max-width: 768px) {
            input[type="date"] {
                min-height: 44px;
            }
            select {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 0.75rem center;
                background-size: 1rem;
                padding-right: 2.5rem;
            }
        }

        /* Autocomplete styles */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 0 0 1rem 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-items div {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .autocomplete-items div:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .autocomplete-active {
            background-color: rgba(0, 122, 255, 0.1) !important;
            color: #007AFF;
        }
        
        .insight-card {
            @apply bg-white/50 backdrop-blur-sm border border-gray-200/50 rounded-xl p-4;
        }
        
        .insight-card:hover {
            @apply bg-white/80 border-gray-300/50 transition-all duration-200;
        }
        
        .insight-card i {
            @apply text-lg;
        }
        
        .insight-card h4 {
            @apply text-sm font-medium text-gray-900;
        }
        
        .insight-card div[id] {
            @apply text-sm text-gray-600;
        }
        
        .quick-question-btn {
            @apply px-4 py-2 text-sm bg-white/50 backdrop-blur-sm border border-gray-200/50 rounded-xl hover:bg-white/80 hover:border-gray-300/50 transition-all duration-200 text-gray-600 flex items-center;
        }
        
        .quick-question-btn:hover {
            @apply transform -translate-y-0.5 shadow-sm;
        }
        
        .quick-question-btn i {
            @apply text-blue-600;
        }
        
        @media (max-width: 640px) {
            .dash-nav-btn {
                @apply text-sm px-2;
            }
            
            .dash-nav-btn i {
                @apply mr-0;
            }
            
            .dash-nav-btn span {
                @apply hidden;
            }
        }
        
        .chat-message {
            @apply p-4 rounded-xl max-w-[85%] break-words relative;
        }
        
        .user-message {
            @apply bg-blue-600 text-white ml-auto;
        }
        
        .ai-message {
            @apply bg-white border border-gray-200/50;
        }
        
        .message-content {
            @apply text-sm sm:text-base leading-relaxed;
        }
        
        .message-time {
            @apply text-xs text-gray-500 mt-2 opacity-75;
        }
        
        #chat-messages::-webkit-scrollbar {
            @apply w-2;
        }
        
        #chat-messages::-webkit-scrollbar-track {
            @apply bg-transparent;
        }
        
        #chat-messages::-webkit-scrollbar-thumb {
            @apply bg-gray-200 rounded-full;
        }
        
        #chat-messages::-webkit-scrollbar-thumb:hover {
            @apply bg-gray-300;
        }
        
        /* Typing indicator animation */
        .typing-indicator {
            @apply flex space-x-1 items-center p-2;
        }
        
        .typing-indicator span {
            @apply w-2 h-2 bg-gray-400 rounded-full;
            animation: typing 1s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        #ai-helper-modal {
            display: none;
        }
        #ai-helper-modal.active {
            display: flex;
        }
        #ai-helper-modal-messages {
            min-height: 200px;
            max-height: 350px;
            overflow-y: auto;
        }
        #ai-helper-modal .chat-message {
            margin-bottom: 1rem;
        }
        #ai-helper-modal .user-message {
            background: #2563eb;
            color: #fff;
            margin-left: auto;
        }
        #ai-helper-modal .ai-message {
            background: #f3f4f6;
            color: #222;
            margin-right: auto;
        }
        #ai-helper-modal .chat-message {
            border-radius: 1rem;
            padding: 1rem;
            max-width: 80%;
            word-break: break-word;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        #ai-helper-modal input:focus {
            outline: none;
        }

        /* Improve form elements on mobile */
        @media (max-width: 768px) {
            input[type="checkbox"] {
                min-height: 24px;
                min-width: 24px;
            }
        }

        /* Toggle checkbox styles */
        .toggle-checkbox {
            position: relative;
            width: 44px;
            height: 24px;
            appearance: none;
            background-color: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-checkbox:checked {
            background-color: #3b82f6;
        }

        .toggle-checkbox::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            background-color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .toggle-checkbox:checked::before {
            transform: translateX(20px);
        }

        /* Theme option styles */
        .theme-option {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-option:hover {
            transform: translateY(-2px);
        }

        .theme-option.ring-2 {
            border-color: #3b82f6;
        }

        /* Dark theme styles */
        .dark {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .dark .card,
        .dark header,
        .dark .stats-card,
        .dark input,
        .dark select,
        .dark textarea {
            background-color: rgba(31, 31, 31, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .dark .nav-btn:not(.active),
        .dark .dash-nav-btn:not(.active) {
            color: #9ca3af;
        }

        .dark .nav-btn.active,
        .dark .dash-nav-btn.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .dark input:focus,
        .dark select:focus,
        .dark textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .dark .text-gray-900 {
            color: #ffffff;
        }

        .dark .text-gray-600 {
            color: #9ca3af;
        }

        .dark .text-gray-500 {
            color: #6b7280;
        }

        .dark .bg-white\/80 {
            background-color: rgba(31, 31, 31, 0.8);
        }

        .dark .border-gray-200\/50 {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .dark .hover\:bg-gray-50:hover {
            background-color: rgba(31, 31, 31, 0.9);
        }
    </style>
</head>
<body class="text-gray-900">

    <div id="app-container" class="container mx-auto p-4 max-w-6xl">

        <!-- Header Section -->
        <header class="flex flex-col lg:flex-row lg:justify-between items-center gap-6 relative">
            <h1 class="text-4xl font-bold tracking-tight bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent">PHAT & FIT</h1>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <div class="flex items-center bg-white/80 backdrop-blur-xl border border-gray-200/50 rounded-2xl shadow-sm">
                    <button id="prev-day-btn" class="p-3 text-gray-400 hover:text-gray-800 transition-colors"><i class="fas fa-chevron-left fa-fw"></i></button>
                    <label for="manual-date-input" class="relative">
                        <span id="date-display" class="block px-4 py-2 text-sm font-medium text-center w-40 cursor-pointer" title="Click to select a date"></span>
                        <input type="date" id="manual-date-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    </label>
                    <button id="next-day-btn" class="p-3 text-gray-400 hover:text-gray-800 transition-colors"><i class="fas fa-chevron-right fa-fw"></i></button>
                </div>
                <div class="bg-white/80 backdrop-blur-xl p-1 rounded-2xl border border-gray-200/50 flex items-center gap-2">
                    <button id="workout-nav-btn" class="nav-btn active">Workout</button>
                    <button id="food-nav-btn" class="nav-btn">Food</button>
                    <button id="dashboard-nav-btn" class="nav-btn"><i class="fas fa-chart-line mr-1"></i>Stats</button>
                    <button id="ai-helper-menu-btn" class="nav-btn flex items-center gap-2"><i class="fas fa-robot"></i><span class="hidden sm:inline">AI Helper</span></button>
                    <button id="settings-nav-btn" class="nav-btn flex items-center gap-2"><i class="fas fa-cog"></i><span class="hidden sm:inline">Settings</span></button>
                </div>
            </div>
        </header>

        <main>
            <!-- Workout Page Content -->
            <div id="workout-page" class="fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card p-8">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-900">Log Workout</h2>
                        <form id="workout-form" class="space-y-6">
                            <input type="hidden" id="edit-workout-id">
                            <select id="workout-category" class="w-full p-4 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500"></select>
                            <div class="relative autocomplete">
                                <input type="text" id="exercise-name" placeholder="Exercise Name" class="w-full p-4 pr-12 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500" required autocomplete="off">
                                <button type="button" id="clear-exercise" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden pointer-events-none">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-600 mb-2 block">Sets</label>
                                    <div class="flex items-center">
                                        <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-l-2xl hover:bg-gray-200 transition-colors" data-input="sets" data-action="decrement">-</button>
                                        <input type="number" id="sets" value="3" class="w-full p-4 text-center border-t border-b border-gray-200 bg-white/80 backdrop-blur-xl" min="1">
                                        <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-r-2xl hover:bg-gray-200 transition-colors" data-input="sets" data-action="increment">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600 mb-2 block">Reps</label>
                                    <div class="flex items-center">
                                        <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-l-2xl hover:bg-gray-200 transition-colors" data-input="reps" data-action="decrement">-</button>
                                        <input type="number" id="reps" value="10" class="w-full p-4 text-center border-t border-b border-gray-200 bg-white/80 backdrop-blur-xl" min="1">
                                        <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-r-2xl hover:bg-gray-200 transition-colors" data-input="reps" data-action="increment">+</button>
                                    </div>
                                </div>
                            </div>
                            <input type="number" step="0.01" id="weight" placeholder="Weight (lb)" class="w-full p-4 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500" inputmode="decimal" pattern="[0-9]*">
                            <textarea id="notes" placeholder="Notes..." class="w-full p-4 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500 h-24"></textarea>
                            <button type="submit" id="submit-workout-btn" class="w-full bg-gray-900 text-white font-medium py-4 rounded-2xl hover:bg-gray-800 transition-colors">Add Exercise</button>
                        </form>
                    </div>
                    <div class="card p-8">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-900">Today's Workouts</h2>
                        <div id="workout-list" class="space-y-4 max-h-[42rem] overflow-y-auto pr-2"></div>
                        <div id="daily-calories-burned-summary" class="mt-6 pt-6 border-t border-gray-200 text-center"></div>
                    </div>
                </div>
            </div>

            <!-- Food Page Content -->
            <div id="food-page" class="hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card p-8">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-900">Log Food</h2>
                        
                        <!-- AI Helper Section -->
                        <div class="mb-8 p-6 bg-gray-50 rounded-2xl border border-gray-200">
                            <h3 class="text-lg font-medium mb-4 text-gray-900">AI Food Helper</h3>
                            <div class="space-y-4">
                                <div class="relative flex flex-col gap-2">
                                    <div class="relative">
                                        <input type="text" id="ai-food-input" placeholder="Describe your food (e.g., 'a medium apple' or '2 slices of whole wheat bread with peanut butter')" class="w-full p-4 pr-12 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500">
                                        <button type="button" id="clear-ai-food" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden pointer-events-none">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <button type="button" id="analyze-food-btn" class="w-full bg-gray-900 text-white font-medium py-4 rounded-2xl hover:bg-gray-800 transition-colors">
                                        Analyze
                                    </button>
                                </div>
                                <div id="ai-result" class="hidden p-4 bg-white rounded-xl border border-gray-200">
                                    <h4 class="font-medium text-gray-900 mb-2">Analysis Result</h4>
                                    <div id="ai-result-content" class="text-sm text-gray-600 mb-4"></div>
                                    <button type="button" id="use-result-btn" class="inline-block px-6 py-2 rounded-full bg-blue-100 text-blue-700 font-semibold text-sm shadow-sm hover:bg-blue-200 transition-colors">
                                        Use This
                                    </button>
                                </div>
                            </div>
                        </div>

                        <form id="food-form" class="space-y-6">
                            <input type="hidden" id="edit-food-id">
                            <div class="relative autocomplete">
                                <input type="text" id="food-name" placeholder="Food Item (e.g., Apple)" class="w-full p-4 pr-12 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500" required autocomplete="off">
                                <button type="button" id="clear-food" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden pointer-events-none">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600 mb-2 block">Quantity</label>
                                <div class="flex items-center">
                                    <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-l-2xl hover:bg-gray-200 transition-colors" data-input="quantity" data-action="decrement">-</button>
                                    <input type="number" id="quantity" value="1" class="w-full p-4 text-center border-t border-b border-gray-200 bg-white/80 backdrop-blur-xl" min="1">
                                    <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-r-2xl hover:bg-gray-200 transition-colors" data-input="quantity" data-action="increment">+</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="calories" placeholder="Calories" class="w-full p-4 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500" required inputmode="numeric" pattern="[0-9]*">
                                <input type="number" id="protein" placeholder="Protein (g)" class="w-full p-4 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500" required inputmode="numeric" pattern="[0-9]*">
                            </div>
                            <button type="submit" id="submit-food-btn" class="w-full bg-gray-900 text-white font-medium py-4 rounded-2xl hover:bg-gray-800 transition-colors">Add Food</button>
                        </form>
                    </div>
                    <div class="card p-8">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-900">Today's Food</h2>
                        <div id="food-list" class="space-y-4 max-h-[42rem] overflow-y-auto pr-2"></div>
                        <div id="daily-nutrition-summary" class="mt-6 pt-6 border-t border-gray-200"></div>
                        
                        <!-- Daily Progress -->
                        <div class="card p-6 mt-6">
                            <h4 class="text-lg font-medium mb-4 text-gray-900">Today's Progress</h4>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">Calorie Goal</span>
                                        <span class="text-sm text-gray-500" id="daily-calorie-progress-text">0/0 cal</span>
                                    </div>
                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-blue-500 rounded-full" id="daily-calorie-progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">Protein Goal</span>
                                        <span class="text-sm text-gray-500" id="daily-protein-progress-text">0/0g</span>
                                    </div>
                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-emerald-500 rounded-full" id="daily-protein-progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page Content -->
            <div id="dashboard-page" class="hidden fade-in space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 class="text-3xl font-bold text-gray-900">Dashboard</h2>
                    <div class="flex items-center space-x-2 text-sm bg-white/80 backdrop-blur-xl border border-gray-200/50 p-1 rounded-2xl">
                        <button id="prev-week-btn" class="p-2 rounded-xl hover:bg-gray-100 transition-colors"><i class="fas fa-chevron-left"></i></button>
                        <div class="flex items-center gap-2 px-2">
                            <input type="date" id="start-date" class="bg-transparent border-none focus:ring-0 p-0 text-center w-32 cursor-pointer" title="Click to select start date">
                            <span class="text-gray-400">to</span>
                            <input type="date" id="end-date" class="bg-transparent border-none focus:ring-0 p-0 text-center w-32 cursor-pointer" title="Click to select end date">
                        </div>
                        <button id="next-week-btn" class="p-2 rounded-xl hover:bg-gray-100 transition-colors"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="bg-white/80 backdrop-blur-xl p-1 rounded-2xl border border-gray-200/50 flex justify-center">
                    <button id="overall-dash-btn" class="dash-nav-btn active">Overall</button>
                    <button id="workout-dash-btn" class="dash-nav-btn">Workout</button>
                    <button id="food-dash-btn" class="dash-nav-btn">Food</button>
                </div>

                <div id="overall-summary-view" class="card p-8">
                    <h3 class="text-2xl font-semibold mb-6 text-gray-900">Overall Summary</h3>
                    <div id="summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8"></div>
                    <div class="space-y-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-medium mb-4 text-gray-900">Daily Nutrition Progress</h3>
                            <div id="nutrition-progress" class="space-y-4"></div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-lg font-medium mb-4 text-gray-900">Daily Workout Progress</h3>
                            <div id="workout-progress" class="space-y-4"></div>
                        </div>
                    </div>
                </div>

                <div id="workout-summary-view" class="hidden card p-8">
                    <h3 class="text-2xl font-semibold mb-6 text-gray-900">Workout Summary</h3>
                    <div id="workout-summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8"></div>
                    <div class="space-y-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-medium mb-4 text-gray-900">Workout Volume by Category</h3>
                            <div id="workout-volume-progress" class="space-y-4"></div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-lg font-medium mb-4 text-gray-900">Workout Insights</h3>
                            <div id="workout-insights" class="space-y-4">
                                <div class="insight-card">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-chart-line text-blue-600"></i>
                                        <h4 class="text-sm font-medium text-gray-900">Progression Trends</h4>
                                    </div>
                                    <div id="progression-trends" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="insight-card">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-balance-scale text-yellow-600"></i>
                                        <h4 class="text-sm font-medium text-gray-900">Muscle Balance</h4>
                                    </div>
                                    <div id="muscle-balance" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="insight-card">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-lightbulb text-green-600"></i>
                                        <h4 class="text-sm font-medium text-gray-900">Workout Variety</h4>
                                    </div>
                                    <div id="workout-variety" class="text-sm text-gray-600"></div>
                                </div>
                                <div class="insight-card">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-trophy text-purple-600"></i>
                                        <h4 class="text-sm font-medium text-gray-900">Recent Achievements</h4>
                                    </div>
                                    <div id="recent-achievements" class="text-sm text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="food-summary-view" class="hidden card p-8">
                    <h3 class="text-2xl font-semibold mb-6 text-gray-900">Food Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Stats Cards -->
                        <div class="card p-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="avg-daily-calories">0</div>
                                    <div class="text-sm text-gray-600">Avg Daily Calories</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-emerald-600" id="avg-daily-protein">0</div>
                                    <div class="text-sm text-gray-600">Avg Daily Protein</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="days-tracked">0</div>
                                    <div class="text-sm text-gray-600">Days Tracked</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-600" id="total-calories">0</div>
                                    <div class="text-sm text-gray-600">Total Calories</div>
                                </div>
                            </div>
                        </div>

                        <!-- Weekly Progress -->
                        <div class="card p-6">
                            <h4 class="text-lg font-medium mb-4 text-gray-900">Weekly Progress</h4>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">Weekly Calorie Goal</span>
                                        <span class="text-sm text-gray-500" id="weekly-calorie-progress-text">0/0 cal</span>
                                    </div>
                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-blue-500 rounded-full" id="weekly-calorie-progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">Weekly Protein Goal</span>
                                        <span class="text-sm text-gray-500" id="weekly-protein-progress-text">0/0g</span>
                                    </div>
                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-emerald-500 rounded-full" id="weekly-protein-progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="goals-summary-view" class="hidden card p-8">
                    <h3 class="text-2xl font-semibold mb-6 text-gray-900">Fitness Goals</h3>
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Nutrition Goals -->
                        <div class="card p-6">
                            <h4 class="text-lg font-medium mb-4 text-gray-900">Nutrition Goals</h4>
                            <form id="nutrition-goals-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Daily Calorie Target</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="calorie-goal" class="flex-1 p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500" placeholder="e.g., 2000">
                                        <span class="text-gray-500">calories</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Daily Protein Target</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="protein-goal" class="flex-1 p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500" placeholder="e.g., 150">
                                        <span class="text-gray-500">grams</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button type="submit" id="save-nutrition-goals" class="flex-1 bg-blue-600 text-white font-medium py-3 rounded-xl hover:bg-blue-700 transition-colors">
                                        Save Nutrition Goals
                                    </button>
                                    <button type="button" id="edit-nutrition-goals" class="hidden bg-gray-600 text-white font-medium py-3 px-4 rounded-xl hover:bg-gray-700 transition-colors">
                                        Edit
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="ai-helper-view" class="hidden card p-8">
                    <h3 class="text-2xl font-semibold mb-6 text-gray-900">AI Helper</h3>
                    <div class="space-y-6">
                        <div class="card p-4 sm:p-6">
                            <div class="flex flex-col space-y-4">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center">
                                        <i class="fas fa-robot text-white"></i>
                                    </div>
                                    <h4 class="text-lg font-medium text-gray-900">Your AI Fitness Assistant</h4>
                                </div>
                                
                                <!-- Chat Messages Container -->
                                <div id="chat-messages" class="flex-1 space-y-4 max-h-[500px] overflow-y-auto p-4 bg-gray-50/50 backdrop-blur-sm rounded-xl">
                                    <!-- Welcome Message -->
                                    <div class="chat-message ai-message">
                                        <div class="message-content">
                                            Hi! I'm your AI fitness assistant. I can help you analyze your workout and nutrition data, provide insights, and answer any fitness-related questions. How can I help you today?
                                        </div>
                                        <div class="message-time">Just now</div>
                                    </div>
                                </div>

                                <!-- Quick Question Buttons -->
                                <div class="flex flex-wrap gap-2 p-2">
                                    <button class="quick-question-btn" data-question="How have I grown in the past week?">
                                        <i class="fas fa-chart-line mr-2"></i>Past Week Progress
                                    </button>
                                    <button class="quick-question-btn" data-question="What's my recommended calorie intake?">
                                        <i class="fas fa-fire mr-2"></i>Calorie Needs
                                    </button>
                                    <button class="quick-question-btn" data-question="How can I improve my workout routine?">
                                        <i class="fas fa-dumbbell mr-2"></i>Workout Tips
                                    </button>
                                    <button class="quick-question-btn" data-question="What's my muscle balance like?">
                                        <i class="fas fa-balance-scale mr-2"></i>Muscle Balance
                                    </button>
                                </div>

                                <!-- Input Area -->
                                <div class="flex items-center gap-2 mt-4">
                                    <div class="flex-1 relative">
                                        <input type="text" id="ai-question" placeholder="Ask me anything about your fitness journey..." class="w-full p-4 pr-12 border border-gray-200 rounded-2xl bg-white/80 backdrop-blur-xl focus:ring-2 focus:ring-blue-500">
                                        <button id="clear-ai-input" class="absolute right-12 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <button id="ask-ai-btn" class="bg-blue-600 text-white px-6 py-4 rounded-xl hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50 fade-in">
        <div class="bg-white/80 backdrop-blur-xl border border-gray-200/50 rounded-3xl shadow-xl p-8 max-w-sm w-full text-center">
            <h2 id="confirm-title" class="text-2xl font-semibold mb-4 text-gray-900">Are you sure?</h2>
            <p id="confirm-text" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-btn" class="bg-gray-100 font-medium py-3 px-6 rounded-2xl hover:bg-gray-200 transition-colors w-full">Cancel</button>
                <button id="confirm-btn" class="bg-red-600 text-white font-medium py-3 px-6 rounded-2xl hover:bg-red-700 transition-colors w-full">Delete</button>
            </div>
        </div>
    </div>

    <!-- AI Helper Modal Popup -->
    <div id="ai-helper-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="relative w-full max-w-2xl mx-auto bg-gray-900/95 backdrop-blur-xl rounded-3xl shadow-2xl flex flex-col border border-gray-800/50" style="min-height: 600px; max-height: 90vh;">
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-800/50 rounded-t-3xl bg-gray-900/80 backdrop-blur-sm">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center shadow-lg border border-gray-700/50">
                        <i class="fas fa-robot text-gray-300 text-xl"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-xl text-white">AI Helper</div>
                        <div class="text-sm text-gray-400 flex items-center gap-2">
                            <span class="inline-block w-2 h-2 bg-emerald-500 rounded-full"></span>
                            Ready to assist
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="new-chat-btn" class="text-sm px-4 py-2 bg-gray-800/80 hover:bg-gray-700/80 text-gray-300 rounded-xl transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow border border-gray-700/50">
                        <i class="fas fa-plus text-emerald-500"></i>
                        New Chat
                    </button>
                    <button id="close-ai-helper-modal" class="text-gray-400 hover:text-gray-300 text-xl p-2 rounded-xl hover:bg-gray-800/80 transition-all duration-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- Welcome Message -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="flex-1 overflow-y-auto p-6" id="ai-helper-modal-messages">
                    <div class="flex flex-col items-center justify-center h-full text-center text-gray-300" id="ai-helper-welcome">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center shadow-lg mb-6 border border-gray-700/50">
                            <i class="fas fa-robot text-gray-300 text-2xl"></i>
                        </div>
                        <div class="font-bold text-2xl mb-3 bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">Welcome to your AI Helper</div>
                        <div class="text-gray-400 max-w-md">I can help you with fitness questions, analyze your workout data, and provide personalized recommendations. What would you like to know?</div>
                    </div>
                </div>
                <!-- Chat Input -->
                <div class="border-t border-gray-800/50 bg-gray-900/80 backdrop-blur-sm p-6">
                    <div class="flex items-center gap-3">
                        <div class="flex-1 relative">
                            <input type="text" id="ai-helper-modal-input" class="w-full p-4 pr-12 rounded-2xl border border-gray-700/50 focus:ring-2 focus:ring-emerald-500 bg-gray-800/90 text-white placeholder-gray-500 shadow-sm" placeholder="Ask me anything about your fitness journey...">
                            <button id="clear-ai-helper-input" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-400 hidden">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <button id="ai-helper-modal-send" class="bg-emerald-600 text-white p-4 rounded-2xl hover:bg-emerald-700 transition-all duration-200 shadow-sm hover:shadow flex items-center justify-center w-14 h-14">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="relative w-full max-w-2xl mx-auto bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl flex flex-col border border-gray-200/50">
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200/50 rounded-t-3xl bg-white/80 backdrop-blur-sm">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center shadow-lg border border-gray-200/50">
                        <i class="fas fa-cog text-gray-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-xl text-gray-900">Settings</div>
                        <div class="text-sm text-gray-500">Customize your nutrition goals</div>
                    </div>
                </div>
                <button id="close-settings-modal" class="text-gray-400 hover:text-gray-600 text-xl p-2 rounded-xl hover:bg-gray-100/80 transition-all duration-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Settings Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-6">
                    <!-- Nutrition Goals -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900">Daily Nutrition Goals</h3>
                        <form id="settings-nutrition-goals" class="space-y-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-600">Daily Calorie Goal</label>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-l-2xl hover:bg-gray-200 transition-colors" data-input="settings-calorie-goal" data-action="decrement">-</button>
                                    <input type="number" id="settings-calorie-goal" value="2000" class="w-full p-4 text-center border-t border-b border-gray-200 bg-white/80 backdrop-blur-xl" min="0" disabled>
                                    <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-r-2xl hover:bg-gray-200 transition-colors" data-input="settings-calorie-goal" data-action="increment">+</button>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-600">Daily Protein Goal (g)</label>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-l-2xl hover:bg-gray-200 transition-colors" data-input="settings-protein-goal" data-action="decrement">-</button>
                                    <input type="number" id="settings-protein-goal" value="150" class="w-full p-4 text-center border-t border-b border-gray-200 bg-white/80 backdrop-blur-xl" min="0" disabled>
                                    <button type="button" class="number-control-btn bg-gray-100 p-4 rounded-r-2xl hover:bg-gray-200 transition-colors" data-input="settings-protein-goal" data-action="increment">+</button>
                                </div>
                            </div>
                            <div class="flex gap-2 pt-4">
                                <button type="submit" id="save-settings-goals" class="flex-1 bg-blue-600 text-white font-medium py-3 rounded-xl hover:bg-blue-700 transition-colors">
                                    Save Goals
                                </button>
                                <button type="button" id="edit-settings-goals" class="hidden bg-gray-600 text-white font-medium py-3 px-4 rounded-xl hover:bg-gray-700 transition-colors">
                                    Edit
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Data Management -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900">Data Management</h3>
                        <div class="space-y-3">
                            <button id="export-data" class="w-full p-4 rounded-2xl border border-gray-200/50 bg-white hover:bg-gray-50 transition-all duration-200 flex items-center gap-3">
                                <i class="fas fa-download text-gray-600"></i>
                                <span>Export Data</span>
                            </button>
                            <button id="import-data" class="w-full p-4 rounded-2xl border border-gray-200/50 bg-white hover:bg-gray-50 transition-all duration-200 flex items-center gap-3">
                                <i class="fas fa-upload text-gray-600"></i>
                                <span>Import Data</span>
                            </button>
                            <button id="clear-data" class="w-full p-4 rounded-2xl border border-red-200/50 bg-white hover:bg-red-50 transition-all duration-200 flex items-center gap-3 text-red-600">
                                <i class="fas fa-trash-alt"></i>
                                <span>Clear All Data</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const getEl = (id) => document.getElementById(id);
    
    // --- DOM SELECTORS ---
    const dateDisplay = getEl('date-display'), manualDateInput = getEl('manual-date-input'), prevDayBtn = getEl('prev-day-btn'), nextDayBtn = getEl('next-day-btn');
    const workoutNavBtn = getEl('workout-nav-btn'), foodNavBtn = getEl('food-nav-btn'), dashboardNavBtn = getEl('dashboard-nav-btn');
    const workoutPage = getEl('workout-page'), foodPage = getEl('food-page'), dashboardPage = getEl('dashboard-page');
    const workoutForm = getEl('workout-form'), workoutList = getEl('workout-list'), categoryInput = getEl('workout-category'), exerciseNameInput = getEl('exercise-name'), setsInput = getEl('sets'), repsInput = getEl('reps'), editWorkoutIdInput = getEl('edit-workout-id'), submitWorkoutBtn = getEl('submit-workout-btn');
    const foodForm = getEl('food-form'), foodList = getEl('food-list'), foodNameInput = getEl('food-name'), caloriesInput = getEl('calories'), proteinInput = getEl('protein'), quantityInput = getEl('quantity'), submitFoodBtn = getEl('submit-food-btn');
    const confirmModal = getEl('confirm-modal');
    const prevWeekBtn = getEl('prev-week-btn'), nextWeekBtn = getEl('next-week-btn'), weekRangeDisplay = getEl('week-range-display');
    const dailyCaloriesBurnedSummary = getEl('daily-calories-burned-summary');
    const dailyNutritionSummary = getEl('daily-nutrition-summary');
    const overallDashBtn = getEl('overall-dash-btn'), workoutDashBtn = getEl('workout-dash-btn'), foodDashBtn = getEl('food-dash-btn');
    const overallSummaryView = getEl('overall-summary-view'), workoutSummaryView = getEl('workout-summary-view'), foodSummaryView = getEl('food-summary-view');
    const aiHelperMenuBtn = getEl('ai-helper-menu-btn');
    const aiHelperModal = getEl('ai-helper-modal');
    const closeAiHelperModal = getEl('close-ai-helper-modal');
    const aiHelperModalInput = getEl('ai-helper-modal-input');
    const aiHelperModalSend = getEl('ai-helper-modal-send');
    const aiHelperModalMessages = getEl('ai-helper-modal-messages');
    const aiHelperWelcome = getEl('ai-helper-welcome');
    const settingsNavBtn = getEl('settings-nav-btn');
    const settingsModal = getEl('settings-modal');
    const closeSettingsModal = getEl('close-settings-modal');
    const themeOptions = document.querySelectorAll('.theme-option');
    const workoutReminders = getEl('workout-reminders');
    const nutritionReminders = getEl('nutrition-reminders');
    const exportDataBtn = getEl('export-data');
    const importDataBtn = getEl('import-data');
    const clearDataBtn = getEl('clear-data');
    const settingsNutritionGoalsForm = getEl('settings-nutrition-goals');
    const settingsCalorieGoal = getEl('settings-calorie-goal');
    const settingsProteinGoal = getEl('settings-protein-goal');
    const saveSettingsGoalsBtn = getEl('save-settings-goals');
    const editSettingsGoalsBtn = getEl('edit-settings-goals');

    // Initialize Settings Modal
    if (settingsNavBtn && settingsModal && closeSettingsModal) {
        settingsNavBtn.addEventListener('click', () => {
            // Load current goals into settings form
            settingsCalorieGoal.value = state.goals.nutrition.calorieGoal || 2000;
            settingsProteinGoal.value = state.goals.nutrition.proteinGoal || 150;
            
            // Check if goals are saved
            const goalsSaved = localStorage.getItem('goalsSaved') === 'true';
            if (goalsSaved) {
                // Disable inputs and show edit button
                settingsCalorieGoal.disabled = true;
                settingsProteinGoal.disabled = true;
                saveSettingsGoalsBtn.textContent = 'Saved';
                saveSettingsGoalsBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                saveSettingsGoalsBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                editSettingsGoalsBtn.classList.remove('hidden');
                
                // Disable number control buttons
                const numberControlBtns = settingsModal.querySelectorAll('.number-control-btn');
                numberControlBtns.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
            } else {
                // Enable inputs and show save button
                settingsCalorieGoal.disabled = false;
                settingsProteinGoal.disabled = false;
                saveSettingsGoalsBtn.textContent = 'Save Goals';
                saveSettingsGoalsBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                saveSettingsGoalsBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                editSettingsGoalsBtn.classList.add('hidden');
                
                // Enable number control buttons
                const numberControlBtns = settingsModal.querySelectorAll('.number-control-btn');
                numberControlBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            }
            
            settingsModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });

        closeSettingsModal.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            document.body.style.overflow = '';
        });

        // Close modal when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        });

        // Close modal when pressing Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !settingsModal.classList.contains('hidden')) {
                settingsModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        });

        // Handle settings nutrition goals form submission
        settingsNutritionGoalsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const calorieGoal = parseInt(settingsCalorieGoal.value) || 2000;
            const proteinGoal = parseInt(settingsProteinGoal.value) || 150;
            
            state.goals.nutrition = {
                calorieGoal,
                proteinGoal
            };
            
            saveData();
            updateGoalsProgress();
            localStorage.setItem('goalsSaved', 'true');
            
            // Update main goals form if it exists
            const mainCalorieGoal = getEl('calorie-goal');
            const mainProteinGoal = getEl('protein-goal');
            if (mainCalorieGoal) mainCalorieGoal.value = calorieGoal;
            if (mainProteinGoal) mainProteinGoal.value = proteinGoal;
            
            // Disable inputs and show edit button
            settingsCalorieGoal.disabled = true;
            settingsProteinGoal.disabled = true;
            saveSettingsGoalsBtn.textContent = 'Saved';
            saveSettingsGoalsBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            saveSettingsGoalsBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            editSettingsGoalsBtn.classList.remove('hidden');
            
            // Disable number control buttons
            const numberControlBtns = settingsModal.querySelectorAll('.number-control-btn');
            numberControlBtns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
        });

        // Handle edit button click
        editSettingsGoalsBtn.addEventListener('click', () => {
            // Enable inputs
            settingsCalorieGoal.disabled = false;
            settingsProteinGoal.disabled = false;
            
            // Update button states
            saveSettingsGoalsBtn.textContent = 'Save Goals';
            saveSettingsGoalsBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            saveSettingsGoalsBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            editSettingsGoalsBtn.classList.add('hidden');
            
            // Enable number control buttons
            const numberControlBtns = settingsModal.querySelectorAll('.number-control-btn');
            numberControlBtns.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        });

        // Handle number control buttons for settings form
        const numberControlBtns = settingsModal.querySelectorAll('.number-control-btn');
        numberControlBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const input = getEl(btn.dataset.input);
                if (input.disabled || btn.disabled) return; // Don't change value if input or button is disabled
                
                const action = btn.dataset.action;
                const currentValue = parseInt(input.value) || 0;
                const step = input.id === 'settings-calorie-goal' ? 50 : 5; // Step size for calories/protein
                
                if (action === 'increment') {
                    input.value = currentValue + step;
                } else if (action === 'decrement') {
                    input.value = Math.max(0, currentValue - step);
                }
            });
        });
    }

    // --- DATA KNOWLEDGE BASE ---
    const commonWorkouts = {
        Legs: [
            'Squat', 'Lunge', 'Deadlift', 'Leg Press', 'Calf Raise', 'Leg Extension', 'Hamstring Curl',
            'Romanian Deadlift', 'Bulgarian Split Squat', 'Hip Thrust', 'Step Up', 'Goblet Squat',
            'Front Squat', 'Hack Squat', 'Leg Curl', 'Leg Abduction', 'Leg Adduction', 'Box Jump',
            'Jump Squat', 'Walking Lunge', 'Reverse Lunge', 'Side Lunge', 'Glute Bridge', 'Hip Abduction',
            'Hip Adduction', 'Seated Calf Raise', 'Standing Calf Raise', 'Donkey Calf Raise'
        ],
        Arms: [
            'Bicep Curl', 'Tricep Extension', 'Hammer Curl', 'Push-up', 'Tricep Dip', 'Preacher Curl',
            'Concentration Curl', 'Incline Curl', 'Spider Curl', 'Cable Curl', 'Skull Crusher',
            'Tricep Pushdown', 'Overhead Tricep Extension', 'Diamond Push-up', 'Close Grip Bench Press',
            'Rope Pushdown', 'Reverse Curl', 'Zottman Curl', 'Cross Body Hammer Curl', 'Incline Hammer Curl',
            'Decline Push-up', 'Tricep Kickback', 'JM Press', 'Lying Tricep Extension', 'Cable Hammer Curl'
        ],
        Shoulders: [
            'Overhead Press', 'Lateral Raise', 'Front Raise', 'Shrugs', 'Arnold Press',
            'Military Press', 'Face Pull', 'Upright Row', 'Reverse Fly', 'Cable Lateral Raise',
            'Front Plate Raise', 'Pike Push-up', 'Handstand Push-up', 'Cable Front Raise',
            'Reverse Pec Deck', 'Cable Face Pull', 'Dumbbell Shoulder Press', 'Barbell Shoulder Press',
            'Machine Shoulder Press', 'Cable Shoulder Press', 'Reverse Cable Fly', 'Cable Shrug',
            'Dumbbell Shrug', 'Barbell Shrug', 'Machine Shrug'
        ],
        Chest: [
            'Bench Press', 'Dumbbell Press', 'Incline Press', 'Decline Press', 'Chest Fly',
            'Push-up', 'Cable Fly', 'Machine Chest Press', 'Incline Dumbbell Press',
            'Decline Dumbbell Press', 'Incline Cable Fly', 'Decline Cable Fly', 'Diamond Push-up',
            'Wide Push-up', 'Close Grip Bench Press', 'Machine Fly', 'Cable Crossover',
            'Incline Cable Crossover', 'Decline Cable Crossover', 'Machine Incline Press',
            'Machine Decline Press', 'Dumbbell Pullover', 'Cable Pullover', 'Machine Pullover',
            'Incline Dumbbell Fly', 'Decline Dumbbell Fly'
        ],
        Back: [
            'Pull-up', 'Lat Pulldown', 'Bent Over Row', 'Seated Row', 'T-Bar Row',
            'Deadlift', 'Face Pull', 'Reverse Fly', 'Cable Row', 'Machine Row',
            'Single Arm Row', 'Inverted Row', 'Chin-up', 'Wide Grip Pull-up',
            'Close Grip Pull-up', 'Neutral Grip Pull-up', 'Barbell Row', 'Dumbbell Row',
            'Cable Lat Pulldown', 'Machine Lat Pulldown', 'Cable Face Pull',
            'Machine Reverse Fly', 'Cable Reverse Fly', 'Dumbbell Reverse Fly',
            'Barbell Reverse Fly', 'Machine Row'
        ],
        Abs: [
            'Crunches', 'Leg Raises', 'Plank', 'Russian Twist', 'Sit-up',
            'Bicycle Crunch', 'Mountain Climber', 'Flutter Kicks', 'V-Up',
            'Ab Wheel Rollout', 'Cable Crunch', 'Machine Crunch', 'Decline Crunch',
            'Reverse Crunch', 'Hanging Leg Raise', 'Cable Woodchop', 'Side Plank',
            'Dead Bug', 'Bird Dog', 'Cable Rotation', 'Machine Rotation',
            'Decline Russian Twist', 'Cable Side Bend', 'Machine Side Bend',
            'Decline Sit-up', 'Machine Sit-up'
        ]
    };

    const commonFoods = {
        // Proteins
        'Chicken Breast (100g)': { calories: 165, protein: 31 },
        'Salmon (100g)': { calories: 208, protein: 20 },
        'Tuna (100g)': { calories: 132, protein: 28 },
        'Ground Beef 90% (100g)': { calories: 176, protein: 26 },
        'Egg (large)': { calories: 78, protein: 6 },
        'Greek Yogurt (1 cup)': { calories: 100, protein: 17 },
        'Cottage Cheese (1 cup)': { calories: 220, protein: 28 },
        'Tofu (100g)': { calories: 76, protein: 8 },
        'Tempeh (100g)': { calories: 192, protein: 20 },
        'Pork Chop (100g)': { calories: 143, protein: 27 },
        'Turkey Breast (100g)': { calories: 157, protein: 30 },
        'Shrimp (100g)': { calories: 99, protein: 24 },
        'Lentils (1 cup cooked)': { calories: 230, protein: 18 },
        'Chickpeas (1 cup cooked)': { calories: 269, protein: 14.5 },
        'Black Beans (1 cup cooked)': { calories: 227, protein: 15 },
        'Quinoa (1 cup cooked)': { calories: 222, protein: 8 },
        'Edamame (1 cup)': { calories: 188, protein: 18 },
        'Protein Shake (1 scoop)': { calories: 120, protein: 24 },
        'Whey Protein (1 scoop)': { calories: 120, protein: 24 },
        'Casein Protein (1 scoop)': { calories: 120, protein: 24 },

        // Dairy
        'Milk (1 cup)': { calories: 103, protein: 8 },
        'Almond Milk (1 cup)': { calories: 30, protein: 1 },
        'Soy Milk (1 cup)': { calories: 80, protein: 7 },
        'Cheese (1 oz)': { calories: 113, protein: 7 },
        'Feta Cheese (1 oz)': { calories: 75, protein: 4 },
        'Mozzarella (1 oz)': { calories: 85, protein: 6 },
        'Cheddar (1 oz)': { calories: 113, protein: 7 },

        // Grains
        'Brown Rice (1 cup cooked)': { calories: 215, protein: 5 },
        'White Rice (1 cup cooked)': { calories: 205, protein: 4 },
        'Oatmeal (1 cup cooked)': { calories: 158, protein: 6 },
        'Whole Wheat Bread (1 slice)': { calories: 79, protein: 4 },
        'Pasta (1 cup cooked)': { calories: 200, protein: 7 },
        'Whole Wheat Pasta (1 cup cooked)': { calories: 174, protein: 7 },
        'Quinoa (1 cup cooked)': { calories: 222, protein: 8 },
        'Barley (1 cup cooked)': { calories: 193, protein: 3.5 },

        // Vegetables
        'Broccoli (1 cup)': { calories: 55, protein: 3.7 },
        'Spinach (1 cup)': { calories: 7, protein: 0.9 },
        'Kale (1 cup)': { calories: 33, protein: 2.9 },
        'Sweet Potato (1 medium)': { calories: 103, protein: 2 },
        'Carrots (1 cup)': { calories: 52, protein: 1.2 },
        'Cauliflower (1 cup)': { calories: 27, protein: 2.1 },
        'Brussels Sprouts (1 cup)': { calories: 38, protein: 3 },
        'Green Beans (1 cup)': { calories: 31, protein: 1.8 },
        'Asparagus (1 cup)': { calories: 27, protein: 2.9 },
        'Bell Pepper (1 medium)': { calories: 31, protein: 1 },
        'Mushrooms (1 cup)': { calories: 15, protein: 2.2 },
        'Zucchini (1 cup)': { calories: 19, protein: 1.4 },
        'Eggplant (1 cup)': { calories: 20, protein: 0.8 },

        // Fruits
        'Apple': { calories: 95, protein: 0.5 },
        'Banana': { calories: 105, protein: 1.3 },
        'Orange': { calories: 62, protein: 1.2 },
        'Strawberries (1 cup)': { calories: 49, protein: 1 },
        'Blueberries (1 cup)': { calories: 84, protein: 1.1 },
        'Grapes (1 cup)': { calories: 104, protein: 1.1 },
        'Watermelon (1 cup)': { calories: 46, protein: 0.9 },
        'Pineapple (1 cup)': { calories: 82, protein: 0.9 },
        'Mango (1 cup)': { calories: 99, protein: 1.4 },
        'Peach': { calories: 59, protein: 1.1 },
        'Pear': { calories: 101, protein: 0.6 },
        'Kiwi': { calories: 42, protein: 0.8 },

        // Nuts and Seeds
        'Almonds (1 oz)': { calories: 164, protein: 6 },
        'Walnuts (1 oz)': { calories: 185, protein: 4.3 },
        'Cashews (1 oz)': { calories: 157, protein: 5.2 },
        'Pistachios (1 oz)': { calories: 159, protein: 5.7 },
        'Pumpkin Seeds (1 oz)': { calories: 151, protein: 7 },
        'Chia Seeds (1 oz)': { calories: 138, protein: 4.7 },
        'Flax Seeds (1 oz)': { calories: 151, protein: 5.2 },
        'Sunflower Seeds (1 oz)': { calories: 164, protein: 5.5 },

        // Common Meals
        'Chicken Salad (1 cup)': { calories: 250, protein: 25 },
        'Tuna Salad (1 cup)': { calories: 200, protein: 30 },
        'Grilled Chicken Sandwich': { calories: 350, protein: 30 },
        'Turkey Sandwich': { calories: 300, protein: 25 },
        'Veggie Burger': { calories: 250, protein: 15 },
        'Chicken Stir Fry (1 cup)': { calories: 300, protein: 25 },
        'Beef Stir Fry (1 cup)': { calories: 350, protein: 30 },
        'Pasta with Meat Sauce (1 cup)': { calories: 400, protein: 20 },
        'Rice and Beans (1 cup)': { calories: 300, protein: 12 },
        'Quinoa Bowl with Vegetables': { calories: 350, protein: 15 }
    };

    // --- APP STATE & LOCALSTORAGE ---
    const getTodayString = () => {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    let state = {
        currentDate: getTodayString(),
        workouts: JSON.parse(localStorage.getItem('workouts')) || {},
        food: JSON.parse(localStorage.getItem('food')) || {},
        favorites: JSON.parse(localStorage.getItem('favorites')) || [],
        itemToDelete: null,
        dashboardWeekOffset: 0,
        activeDashboardView: 'overall',
        customDateRange: false,
        goals: JSON.parse(localStorage.getItem('goals')) || {
            nutrition: {
                calorieGoal: 2000,
                proteinGoal: 150
            }
        }
    };
    
    const saveData = () => {
        localStorage.setItem('workouts', JSON.stringify(state.workouts));
        localStorage.setItem('food', JSON.stringify(state.food));
        localStorage.setItem('favorites', JSON.stringify(state.favorites));
        localStorage.setItem('goals', JSON.stringify(state.goals));
    };

    const showPage = (pageName) => {
        workoutPage.classList.add('hidden');
        foodPage.classList.add('hidden');
        dashboardPage.classList.add('hidden');
        
        workoutNavBtn.classList.remove('active');
        foodNavBtn.classList.remove('active');
        dashboardNavBtn.classList.remove('active');

        if (pageName === 'workout') {
            workoutPage.classList.remove('hidden');
            workoutNavBtn.classList.add('active');
        } else if (pageName === 'food') {
            foodPage.classList.remove('hidden');
            foodNavBtn.classList.add('active');
            updateFoodProgress(); // Add this line to update progress when showing food page
        } else {
            state.dashboardWeekOffset = 0;
            dashboardPage.classList.remove('hidden');
            dashboardNavBtn.classList.add('active');
            showDashboardView('overall');
        }
    };
    
    const showDashboardView = (viewName) => {
        state.activeDashboardView = viewName;
        overallSummaryView.classList.add('hidden');
        workoutSummaryView.classList.add('hidden');
        foodSummaryView.classList.add('hidden');

        overallDashBtn.classList.remove('active');
        workoutDashBtn.classList.remove('active');
        foodDashBtn.classList.remove('active');

        if(viewName === 'overall'){
            overallSummaryView.classList.remove('hidden');
            overallDashBtn.classList.add('active');
        } else if (viewName === 'workout'){
            workoutSummaryView.classList.remove('hidden');
            workoutDashBtn.classList.add('active');
            // Generate workout insights only when workout view is active
            const { startDate, endDate } = getDateRange();
            const exerciseProgression = {};
            const categoryVolume = {};
            const exerciseFrequency = {};
            const recentPRs = [];
            
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dayString = currentDate.toISOString().split('T')[0];
                if (state.workouts && state.workouts[dayString]) {
                    state.workouts[dayString].forEach(w => {
                        categoryVolume[w.category] = (categoryVolume[w.category] || 0) + (Number(w.reps) * Number(w.weight));
                        exerciseFrequency[w.name] = (exerciseFrequency[w.name] || 0) + 1;
                        
                        if (!exerciseProgression[w.name]) {
                            exerciseProgression[w.name] = [];
                        }
                        exerciseProgression[w.name].push({
                            date: new Date(dayString),
                            weight: Number(w.weight),
                            sets: Number(w.sets),
                            reps: Number(w.reps)
                        });
                        
                        if (checkForPR(w.name, w.weight)) {
                            recentPRs.push({
                                name: w.name,
                                weight: w.weight,
                                date: new Date(dayString)
                            });
                        }
                    });
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            generateWorkoutInsights(exerciseProgression, categoryVolume, exerciseFrequency, recentPRs);
        } else if (viewName === 'food') {
            foodSummaryView.classList.remove('hidden');
            foodDashBtn.classList.add('active');
        } else if (viewName === 'goals') {
            goalsSummaryView.classList.remove('hidden');
            goalsDashBtn.classList.add('active');
            updateGoalsProgress();
        }
        renderSummary();
    };


    const renderAll = () => {
        updateDateDisplay();
        renderWorkouts();
        renderFoodLog();
        if (!dashboardPage.classList.contains('hidden')) {
            renderSummary();
        }
    };

    const updateDateDisplay = () => {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        const currentDateObj = new Date(state.currentDate + 'T00:00:00');

        let displayText;
        if (currentDateObj.toDateString() === today.toDateString()) displayText = "Today";
        else if (currentDateObj.toDateString() === yesterday.toDateString()) displayText = "Yesterday";
        else displayText = currentDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        dateDisplay.textContent = displayText;
        manualDateInput.value = state.currentDate;
    };

    const calculateCaloriesBurned = (workout) => {
        const reps = Number(workout.reps) || 0;
        const sets = Number(workout.sets) || 0;
        const weight = Number(workout.weight) || 1;
        const categoryMultipliers = { Legs: 1.5, Back: 1.5, Chest: 1.2, Shoulders: 1.2, Arms: 1.0, Abs: 1.0 };
        const multiplier = categoryMultipliers[workout.category] || 1.0;
        return sets * reps * 0.25 * multiplier * (1 + (Math.log(weight) / 10));
    };

    const renderWorkouts = () => {
        workoutList.innerHTML = '';
        const dailyWorkouts = state.workouts[state.currentDate] || [];
        let dailyCaloriesBurned = 0;

        if (dailyWorkouts.length === 0) {
            workoutList.innerHTML = `<p class="text-gray-500 text-center py-8">No workouts logged.</p>`;
        } else {
            dailyWorkouts.forEach(workout => {
                // Use AI calories if available, otherwise fallback to calculated
                dailyCaloriesBurned += (typeof workout.caloriesBurned === 'number' && !isNaN(workout.caloriesBurned))
                    ? workout.caloriesBurned
                    : calculateCaloriesBurned(workout);
                const isPR = checkForPR(workout.name, workout.weight);
                const card = document.createElement('div');
                card.className = 'list-item fade-in';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="w-full">
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold text-gray-900">${workout.name} <span class="text-xs font-medium text-gray-500">(${workout.category})</span></h4>
                                <div class="flex items-center space-x-2">
                                    <button onclick="editWorkout('${workout.id}')" class="p-2 text-gray-400 hover:text-gray-600 transition-colors"><i class="fas fa-pencil-alt h-4 w-4"></i></button>
                                    <button onclick="requestDeleteItem('workouts', '${workout.id}')" class="p-2 text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt h-4 w-4"></i></button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">
                                ${workout.sets} sets, ${workout.reps} reps @ ${workout.weight} lb
                                ${workout.caloriesBurned ? `<span class=\"ml-2 text-xs text-blue-600\">AI: ${Math.round(workout.caloriesBurned)} cal</span>` : ''}
                                ${isPR ? `<span class=\"ml-2 bg-yellow-400/20 text-yellow-800 text-xs font-medium px-2 py-0.5 rounded-full\">PR!</span>` : ''}
                            </p>
                            ${workout.notes ? `
                            <div class="mt-2">
                                <button onclick="this.parentElement.querySelector('.notes-content').classList.toggle('hidden')" class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                    Notes
                                </button>
                                <div class="notes-content hidden mt-1 text-sm text-gray-600 bg-gray-50 p-2 rounded-lg">
                                    ${workout.notes}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>`;
                workoutList.appendChild(card);
            });
        }
        
        dailyCaloriesBurnedSummary.innerHTML = `
            <div class="stats-card">
                <p class="text-sm text-gray-500">Est. Calories Burned</p>
                <p class="text-3xl font-semibold text-blue-600 mt-1">${Math.round(dailyCaloriesBurned)}</p>
            </div>`;
    };
    
    const renderFoodLog = () => {
        foodList.innerHTML = '';
        const dailyFood = state.food[state.currentDate] || [];
        let totalCals = 0, totalProt = 0;

        if (dailyFood.length === 0) {
            foodList.innerHTML = `<p class="text-gray-500 text-center py-8">No food logged.</p>`;
        } else {
            dailyFood.forEach(item => {
                totalCals += (item.calories || 0) * (item.quantity || 1);
                totalProt += (item.protein || 0) * (item.quantity || 1);
                const card = document.createElement('div');
                card.className = 'list-item fade-in';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-gray-900">${item.quantity} x ${item.name}</h4>
                            <p class="text-sm text-gray-600 mt-1">${item.calories} kcal, ${item.protein}g protein (each)</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editFood('${item.id}')" class="p-2 text-gray-400 hover:text-gray-600 transition-colors"><i class="fas fa-pencil-alt h-4 w-4"></i></button>
                            <button onclick="requestDeleteItem('food', '${item.id}')" class="p-2 text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt h-4 w-4"></i></button>
                        </div>
                    </div>`;
                foodList.appendChild(card);
            });
        }

        dailyNutritionSummary.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div class="stats-card">
                    <p class="text-sm text-gray-500">Total Calories</p>
                    <p class="text-3xl font-semibold text-blue-600 mt-1">${Math.round(totalCals)}</p>
                </div>
                <div class="stats-card">
                    <p class="text-sm text-gray-500">Total Protein</p>
                    <p class="text-3xl font-semibold text-blue-600 mt-1">${Math.round(totalProt)}g</p>
                </div>
            </div>`;
    };

    let nutritionChart, dailyEffortChart, workoutVolumeChart, foodDetailsChart;
    const getDateRange = () => {
        if (state.customDateRange) {
            return {
                startDate: new Date(getEl('start-date').value),
                endDate: new Date(getEl('end-date').value)
            };
        }

        const baseDate = new Date();
        baseDate.setDate(baseDate.getDate() + (state.dashboardWeekOffset * 7));
        const dayOfWeek = baseDate.getDay();
        const startOfWeek = new Date(baseDate);
        startOfWeek.setDate(baseDate.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        return { startDate: startOfWeek, endDate: endOfWeek };
    };

    const updateDateInputs = (startDate, endDate) => {
        getEl('start-date').value = startDate.toISOString().split('T')[0];
        getEl('end-date').value = endDate.toISOString().split('T')[0];
    };

    const renderSummary = () => {
        const { startDate, endDate } = getDateRange();
        updateDateInputs(startDate, endDate);
        
        const labels = [], calorieData = [], proteinData = [];
        let totalCalories = 0, totalProtein = 0, totalCaloriesBurned = 0;
        
        const commonFoods = {};
        
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dayString = currentDate.toISOString().split('T')[0];
            labels.push(currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));

            // Calculate calories burned from workouts
            if (state.workouts && state.workouts[dayString]) {
                state.workouts[dayString].forEach(w => {
                    totalCaloriesBurned += calculateCaloriesBurned(w);
                });
            }

            let dailyCals = 0, dailyProt = 0;
            if (state.food && state.food[dayString]) {
                state.food[dayString].forEach(f => {
                    dailyCals += f.calories * f.quantity;
                    dailyProt += f.protein * f.quantity;
                    
                    // Track common foods
                    if (!commonFoods[f.name]) {
                        commonFoods[f.name] = {
                            frequency: 0,
                            totalCalories: 0,
                            totalProtein: 0
                        };
                    }
                    commonFoods[f.name].frequency++;
                    commonFoods[f.name].totalCalories += f.calories * f.quantity;
                    commonFoods[f.name].totalProtein += f.protein * f.quantity;
                });
            }
            totalCalories += dailyCals;
            totalProtein += dailyProt;
            calorieData.push(dailyCals);
            proteinData.push(dailyProt);

            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        const avgCalories = Math.round(totalCalories / labels.length);
        const avgProtein = Math.round(totalProtein / labels.length);
        const daysTracked = labels.filter((_, i) => calorieData[i] > 0).length;

        // Calculate workout days this week
        let workoutDaysThisWeek = 0;
        currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dayString = currentDate.toISOString().split('T')[0];
            if (state.workouts && state.workouts[dayString] && state.workouts[dayString].length > 0) {
                workoutDaysThisWeek++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }

        // Update food summary stats
        getEl('summary-stats').innerHTML = `
            <div class="stats-card">
                <p class="text-sm text-gray-500">Avg Cals</p>
                <p class="text-2xl font-semibold text-gray-900 mt-1">${avgCalories}</p>
            </div>
            <div class="stats-card">
                <p class="text-sm text-gray-500">Avg Protein</p>
                <p class="text-2xl font-semibold text-gray-900 mt-1">${avgProtein}g</p>
            </div>
            <div class="stats-card">
                <p class="text-sm text-gray-500">Workout Days</p>
                <p class="text-2xl font-semibold text-gray-900 mt-1">${workoutDaysThisWeek}/7</p>
            </div>
            <div class="stats-card">
                <p class="text-sm text-gray-500">Cals Burned</p>
                <p class="text-2xl font-semibold text-gray-900 mt-1">${Math.round(totalCaloriesBurned)}</p>
            </div>`;

        // Render nutrition progress
        const nutritionProgress = getEl('nutrition-progress');
        nutritionProgress.innerHTML = '';
        for (let i = 0; i < 7; i++) {
            const day = labels[i];
            const calories = calorieData[i];
            const protein = proteinData[i];
            const maxCalories = Math.max(...calorieData);
            
            nutritionProgress.innerHTML += `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">${day}</span>
                        <span class="text-sm text-gray-500">${calories} cal / ${protein}g protein</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: ${(calories / maxCalories) * 100}%"></div>
                    </div>
                </div>`;
        }
    };

    const generateWorkoutInsights = (progression, categoryVolume, frequency, recentPRs) => {
        // Progression Trends
        const progressionTrends = getEl('progression-trends');
        const topExercises = Object.entries(progression)
            .filter(([, data]) => data.length >= 3)
            .sort(([, a], [, b]) => {
                const aProgress = calculateProgress(a);
                const bProgress = calculateProgress(b);
                return bProgress - aProgress;
            })
            .slice(0, 3);

        progressionTrends.innerHTML = topExercises.map(([exercise, data]) => {
            const progress = calculateProgress(data);
            const trend = progress > 0 ? '' : progress < 0 ? '' : '';
            return `<div class="mb-2">${exercise}: ${trend} ${Math.abs(progress)}% change</div>`;
        }).join('') || '<div class="text-gray-500">Not enough data to show trends</div>';

        // Muscle Balance
        const muscleBalance = getEl('muscle-balance');
        const totalVolume = Object.values(categoryVolume).reduce((a, b) => a + b, 0);
        const imbalances = Object.entries(categoryVolume)
            .map(([category, volume]) => ({
                category,
                percentage: (volume / totalVolume) * 100
            }))
            .sort((a, b) => b.percentage - a.percentage);

        muscleBalance.innerHTML = imbalances.map(({ category, percentage }) => {
            const status = percentage > 30 ? '' : percentage < 10 ? '' : '';
            return `<div class="mb-2">${category}: ${status} ${Math.round(percentage)}% of total volume</div>`;
        }).join('');

        // Workout Variety
        const workoutVariety = getEl('workout-variety');
        const totalExercises = Object.keys(frequency).length;
        const mostFrequent = Object.entries(frequency)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 3);
        const leastFrequent = Object.entries(frequency)
            .sort(([, a], [, b]) => a - b)
            .slice(0, 3);

        workoutVariety.innerHTML = `
            <div class="mb-2">Total unique exercises: ${totalExercises}</div>
            <div class="mb-2">Most frequent: ${mostFrequent.map(([name]) => name).join(', ')}</div>
            <div class="mb-2">Try more: ${leastFrequent.map(([name]) => name).join(', ')}</div>
        `;

        // Recent Achievements
        const recentAchievements = getEl('recent-achievements');
        const sortedPRs = recentPRs
            .sort((a, b) => b.date - a.date)
            .slice(0, 3);

        recentAchievements.innerHTML = sortedPRs.map(pr => {
            const date = pr.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return `<div class="mb-2"> New PR: ${pr.name} (${pr.weight}lb) on ${date}</div>`;
        }).join('') || '<div class="text-gray-500">No recent achievements</div>';
    };

    const calculateProgress = (data) => {
        if (data.length < 2) return 0;
        const sorted = data.sort((a, b) => a.date - b.date);
        const first = sorted[0];
        const last = sorted[sorted.length - 1];
        const firstVolume = first.weight * first.sets * first.reps;
        const lastVolume = last.weight * last.sets * last.reps;
        return ((lastVolume - firstVolume) / firstVolume) * 100;
    };

    const fullResetWorkoutForm = () => { 
        workoutForm.reset(); 
        setsInput.value = 3; 
        repsInput.value = 10; 
        partialResetWorkoutForm(); 
    };
    const partialResetWorkoutForm = () => {
        exerciseNameInput.value = '';
        getEl('weight').value = ''; 
        editWorkoutIdInput.value = '';
        submitWorkoutBtn.innerHTML = 'Add Exercise';
        submitWorkoutBtn.classList.remove('bg-green-600');
        submitWorkoutBtn.classList.add('bg-gray-900');
    };
    const resetFoodForm = () => { foodForm.reset(); quantityInput.value = 1; getEl('edit-food-id').value = ''; submitFoodBtn.innerHTML = 'Add Food'; submitFoodBtn.classList.remove('bg-green-600'); submitFoodBtn.classList.add('bg-gray-900'); };

    window.editWorkout = (id) => {
        showPage('workout');
        const workout = state.workouts[state.currentDate]?.find(w => w.id === id);
        if (!workout) return;
        editWorkoutIdInput.value = id; categoryInput.value = workout.category;
        exerciseNameInput.value = workout.name; setsInput.value = workout.sets;
        repsInput.value = workout.reps; getEl('weight').value = workout.weight;
        getEl('notes').value = workout.notes;
        submitWorkoutBtn.innerHTML = 'Update Exercise';
        submitWorkoutBtn.classList.remove('bg-gray-900');
        submitWorkoutBtn.classList.add('bg-green-600');
    };
    
    window.editFood = (id) => {
        const food = state.food[state.currentDate]?.find(f => f.id === id);
        if (!food) return;
        getEl('edit-food-id').value = id;
        foodNameInput.value = food.name;
        quantityInput.value = food.quantity;
        caloriesInput.value = food.calories;
        proteinInput.value = food.protein;
        submitFoodBtn.innerHTML = 'Update Food';
        submitFoodBtn.classList.remove('bg-gray-900');
        submitFoodBtn.classList.add('bg-green-600');
    };
    
    window.requestDeleteItem = (type, id) => {
        state.itemToDelete = { type, id };
        getEl('confirm-title').textContent = `Delete this ${type === 'workouts' ? 'workout' : 'food item'}?`;
        confirmModal.classList.remove('hidden');
    };
    
    const deleteItem = ({ type, id }) => {
        if (!type || !id || !state[type] || !state[type][state.currentDate]) return;
        state[type][state.currentDate] = state[type][state.currentDate].filter(item => item.id !== id);
        if (state[type][state.currentDate].length === 0) {
            delete state[type][state.currentDate];
        }
        saveData();
        renderAll();
    };

    const checkForPR = (name, weight) => {
        let maxWeight = 0;
        Object.keys(state.workouts).forEach(date => {
            if (date === state.currentDate) return;
            state.workouts[date].forEach(w => {
                if (w.name.toLowerCase() === name.toLowerCase() && w.weight > maxWeight) {
                    maxWeight = w.weight;
                }
            });
        });
        return weight > maxWeight;
    };
    
    const changeDate = (days) => {
        const currentDateObj = new Date(state.currentDate + 'T00:00:00');
        currentDateObj.setDate(currentDateObj.getDate() + days);
        state.currentDate = currentDateObj.toISOString().split('T')[0];
        renderAll();
    };

    function setupAutocomplete(inp, getSuggestions, onSelect) {
        let currentFocus;
        inp.addEventListener("input", function(e) {
            let a, b, i, val = this.value;
            closeAllLists();
            if (!val) { return false; }
            currentFocus = -1;
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);

            const suggestions = getSuggestions();
            suggestions.forEach(item => {
                if (item.substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                    b = document.createElement("DIV");
                    b.innerHTML = "<strong>" + item.substr(0, val.length) + "</strong>";
                    b.innerHTML += item.substr(val.length);
                    b.innerHTML += "<input type='hidden' value='" + item + "'>";
                    b.addEventListener("click", function(e) {
                        const selectedValue = this.getElementsByTagName("input")[0].value;
                        inp.value = selectedValue;
                        if(onSelect) onSelect(selectedValue);
                        closeAllLists();
                    });
                    a.appendChild(b);
                }
            });
        });

        inp.addEventListener("keydown", function(e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) { currentFocus++; addActive(x); } 
            else if (e.keyCode == 38) { currentFocus--; addActive(x); } 
            else if (e.keyCode == 13) { e.preventDefault(); if (currentFocus > -1) { if (x) x[currentFocus].click(); } }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }
        function removeActive(x) { for (let i = 0; i < x.length; i++) { x[i].classList.remove("autocomplete-active"); } }
        function closeAllLists(elmnt) {
            const x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }
        document.addEventListener("click", function (e) { closeAllLists(e.target); });
    }

    prevDayBtn.addEventListener('click', () => changeDate(-1));
    nextDayBtn.addEventListener('click', () => changeDate(1));
    manualDateInput.addEventListener('change', (e) => {
        if(e.target.value) { state.currentDate = e.target.value; renderAll(); }
    });

    workoutNavBtn.addEventListener('click', () => showPage('workout'));
    foodNavBtn.addEventListener('click', () => showPage('food'));
    dashboardNavBtn.addEventListener('click', () => showPage('dashboard'));
    
    overallDashBtn.addEventListener('click', () => showDashboardView('overall'));
    workoutDashBtn.addEventListener('click', () => showDashboardView('workout'));
    foodDashBtn.addEventListener('click', () => showDashboardView('food'));

    categoryInput.addEventListener('change', () => {
        exerciseNameInput.value = '';
    });

    // AI-powered calories burned estimation for workouts
    async function estimateCaloriesWithAI(workout) {
        const description = `Estimate the calories burned for the following workout: ${workout.sets} sets of ${workout.reps} reps of ${workout.name} at ${workout.weight} lbs. Respond with only the number of calories burned as a JSON object: {\"calories\": 123}`;
        const response = await fetch('https://ai-proxy-git-main-daniels-projects-dce54a5d.vercel.app/api/openai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: [
                    { role: "system", content: "You are a fitness expert." },
                    { role: "user", content: description }
                ]
            })
        });
        const data = await response.json();
        if (data.choices && data.choices[0]) {
            try {
                const result = JSON.parse(data.choices[0].message.content);
                return result.calories;
            } catch (e) {
                return null;
            }
        }
        return null;
    }

    workoutForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const editingId = editWorkoutIdInput.value;
        const weightInput = getEl('weight');
        const weightValue = weightInput.value === '' ? 0 : parseFloat(weightInput.value);
        const workoutData = {
            name: exerciseNameInput.value.trim(),
            category: categoryInput.value,
            sets: setsInput.value,
            reps: repsInput.value,
            weight: weightValue,
            notes: getEl('notes').value.trim()
        };

        // Show loading state
        submitWorkoutBtn.innerHTML = editingId ? 'Estimating...' : 'Estimating...';
        submitWorkoutBtn.disabled = true;

        // Get AI calories estimate
        const aiCalories = await estimateCaloriesWithAI(workoutData);
        workoutData.caloriesBurned = aiCalories;

        // Restore button state
        submitWorkoutBtn.innerHTML = editingId ? 'Update Exercise' : 'Add Exercise';
        submitWorkoutBtn.disabled = false;

        if (editingId) {
            const index = state.workouts[state.currentDate].findIndex(w => w.id === editingId);
            if (index > -1) state.workouts[state.currentDate][index] = { ...state.workouts[state.currentDate][index], ...workoutData };
        } else {
            if (!state.workouts[state.currentDate]) state.workouts[state.currentDate] = [];
            state.workouts[state.currentDate].push({ id: Date.now().toString(), ...workoutData });
        }
        saveData(); renderAll(); partialResetWorkoutForm();
    });

    foodForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const editingId = getEl('edit-food-id').value;
        const foodData = { 
            name: foodNameInput.value.trim(), 
            calories: parseInt(caloriesInput.value) || 0, 
            protein: parseInt(proteinInput.value) || 0,
            quantity: parseInt(quantityInput.value) || 1,
        };
        if (editingId) {
             const index = state.food[state.currentDate].findIndex(f => f.id === editingId);
            if (index > -1) state.food[state.currentDate][index] = { ...state.food[state.currentDate][index], ...foodData };
        } else {
            if (!state.food[state.currentDate]) state.food[state.currentDate] = [];
            state.food[state.currentDate].push({ id: Date.now().toString(), ...foodData });
        }
        saveData(); 
        renderAll(); 
        updateFoodProgress(); // Add this line to update progress after saving food
        resetFoodForm();
    });

    getEl('cancel-btn').addEventListener('click', () => { confirmModal.classList.add('hidden'); });
    getEl('confirm-btn').addEventListener('click', () => {
        if(state.itemToDelete) deleteItem(state.itemToDelete);
        confirmModal.classList.add('hidden');
    });

    document.querySelectorAll('.number-control-btn').forEach(btn => btn.addEventListener('click', () => {
        const input = getEl(btn.dataset.input); let value = parseInt(input.value);
        if (btn.dataset.action === 'increment') value++; else if (value > 1) value--;
        input.value = value;
    }));
    
    prevWeekBtn.addEventListener('click', () => {
        state.customDateRange = false;
        state.dashboardWeekOffset--;
        renderSummary();
    });

    nextWeekBtn.addEventListener('click', () => {
        state.customDateRange = false;
        state.dashboardWeekOffset++;
        renderSummary();
    });

    // Add event listeners for date inputs
    getEl('start-date').addEventListener('change', () => {
        state.customDateRange = true;
        renderSummary();
    });

    getEl('end-date').addEventListener('change', () => {
        state.customDateRange = true;
        renderSummary();
    });

    // Initialize date inputs
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    updateDateInputs(startOfWeek, endOfWeek);

    const initializeApp = () => {
        const categories = ['Legs', 'Arms', 'Shoulders', 'Chest', 'Back', 'Abs'];
        categories.forEach(cat => categoryInput.add(new Option(cat, cat)));
        
        // Add clear button functionality
        const clearExerciseBtn = getEl('clear-exercise');
        const clearFoodBtn = getEl('clear-food');

        exerciseNameInput.addEventListener('input', () => {
            clearExerciseBtn.classList.toggle('hidden', !exerciseNameInput.value);
            clearExerciseBtn.style.pointerEvents = exerciseNameInput.value ? 'auto' : 'none';
        });

        foodNameInput.addEventListener('input', () => {
            clearFoodBtn.classList.toggle('hidden', !foodNameInput.value);
            clearFoodBtn.style.pointerEvents = foodNameInput.value ? 'auto' : 'none';
        });
        
        clearExerciseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exerciseNameInput.value = '';
            clearExerciseBtn.classList.add('hidden');
            clearExerciseBtn.style.pointerEvents = 'none';
            exerciseNameInput.focus();
        });

        clearFoodBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            foodNameInput.value = '';
            clearFoodBtn.classList.add('hidden');
            clearFoodBtn.style.pointerEvents = 'none';
            foodNameInput.focus();
        });
        
        // Initialize goals form values and button state
        const savedGoals = localStorage.getItem('goals');
        if (savedGoals) {
            const goals = JSON.parse(savedGoals);
            if (goals.nutrition) {
                getEl('calorie-goal').value = goals.nutrition.calories || '';
                getEl('protein-goal').value = goals.nutrition.protein || '';
                const saveBtn = getEl('save-nutrition-goals');
                const editBtn = getEl('edit-nutrition-goals');
                saveBtn.textContent = 'Saved';
                saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                saveBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                editBtn.classList.remove('hidden');
                // Disable inputs by default
                getEl('calorie-goal').disabled = true;
                getEl('protein-goal').disabled = true;
            }
        }
        
        setupAutocomplete(exerciseNameInput, () => {
            const currentCategory = categoryInput.value;
            const userExercises = Object.values(state.workouts).flat()
                .filter(w => w.category === currentCategory)
                .map(w => w.name);
            const common = commonWorkouts[currentCategory] || [];
            return [...new Set([...userExercises, ...common])];
        });

        setupAutocomplete(foodNameInput, 
            () => {
                const userFoods = Object.values(state.food).flat().map(f => f.name);
                const commonFoodNames = Object.keys(commonFoods);
                return [...new Set([...userFoods, ...commonFoodNames])];
            },
            (selectedValue) => {
                const allFood = Object.values(state.food).flat();
                const lastEntry = allFood.reverse().find(f => f.name === selectedValue);
                if (lastEntry) {
                    caloriesInput.value = lastEntry.calories;
                    proteinInput.value = lastEntry.protein;
                } else if (commonFoods[selectedValue]) {
                    caloriesInput.value = commonFoods[selectedValue].calories;
                    proteinInput.value = commonFoods[selectedValue].protein;
                }
            }
        );

        showPage('workout');
        renderAll();
    };
    
    initializeApp();

    // AI Helper Functions
    const analyzeFood = async (description) => {
        try {
            const response = await fetch('https://ai-proxy-git-main-daniels-projects-dce54a5d.vercel.app/api/openai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: [
                        {
                            role: "system",
                            content: "You are a nutrition expert. Analyze the given food description and provide the estimated calories and protein content. Format your response as JSON with 'calories' and 'protein' fields. Be as accurate as possible based on standard serving sizes. Example response format: {\"calories\": 150, \"protein\": 5}"
                        },
                        {
                            role: "user",
                            content: description
                        }
                    ]
                })
            });

            const data = await response.json();
            if (data.error) {
                alert(`API Error: ${data.error.message}`);
                return null;
            }
            if (data.choices && data.choices[0]) {
                const content = data.choices[0].message.content;
                try {
                    const result = JSON.parse(content);
                    if (typeof result.calories === 'number' && typeof result.protein === 'number') {
                        return result;
                    } else {
                        return null;
                    }
                } catch (e) {
                    return null;
                }
            }
        } catch (error) {
            alert('Error connecting to proxy API. Please check your internet connection and try again.');
            return null;
        }
    };

    const showAIResult = (result) => {
        const resultDiv = getEl('ai-result');
        const contentDiv = getEl('ai-result-content');
        
        if (result) {
            contentDiv.innerHTML = `
                <div class="space-y-2">
                    <p>Estimated calories: ${result.calories}</p>
                    <p>Estimated protein: ${result.protein}g</p>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        } else {
            contentDiv.innerHTML = '<p class="text-red-600">Sorry, I couldn\'t analyze that food item. Please try a different description.</p>';
            resultDiv.classList.remove('hidden');
        }
    };

    const useAIResult = (result) => {
        if (result) {
            foodNameInput.value = getEl('ai-food-input').value;
            caloriesInput.value = result.calories;
            proteinInput.value = result.protein;
            getEl('ai-result').classList.add('hidden');
        }
    };

    // Add event listeners for AI helper
    getEl('analyze-food-btn').addEventListener('click', async () => {
        const description = getEl('ai-food-input').value.trim();
        if (!description) return;
        
        const result = await analyzeFood(description);
        showAIResult(result);
    });

    getEl('use-result-btn').addEventListener('click', () => {
        const content = getEl('ai-result-content').textContent;
        const calories = parseInt(content.match(/calories: (\d+)/)?.[1]);
        const protein = parseInt(content.match(/protein: (\d+)g/)?.[1]);
        
        if (calories && protein) {
            useAIResult({ calories, protein });
        }
    });

    // Add clear button functionality for AI food input
    const clearAIFoodBtn = document.getElementById('clear-ai-food');
    const aiFoodInput = document.getElementById('ai-food-input');
    aiFoodInput.addEventListener('input', () => {
        clearAIFoodBtn.classList.toggle('hidden', !aiFoodInput.value);
        clearAIFoodBtn.style.pointerEvents = aiFoodInput.value ? 'auto' : 'none';
    });
    clearAIFoodBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        aiFoodInput.value = '';
        clearAIFoodBtn.classList.add('hidden');
        clearAIFoodBtn.style.pointerEvents = 'none';
        aiFoodInput.focus();
    });

    // Add event listeners for AI question submission
    getEl('ask-ai-btn').addEventListener('click', async () => {
        const question = getEl('ai-question').value.trim();
        if (!question) return;
        
        // Add user message to chat
        addMessageToChat('user', question);
        
        // Clear input
        getEl('ai-question').value = '';
        
        // Show loading state
        const loadingId = addMessageToChat('ai', 'Analyzing your data...', true);
        
        // Analyze user data based on the question
        const { startDate, endDate } = getDateRange();
        const userData = analyzeUserData(startDate, endDate);
        
        const response = await fetch('https://ai-proxy-git-main-daniels-projects-dce54a5d.vercel.app/api/openai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: [
                    { 
                        role: "system", 
                        content: `You are a fitness AI assistant. Analyze the following user data and provide personalized insights: ${JSON.stringify(userData)}` 
                    },
                    { role: "user", content: question }
                ]
            })
        });

        const data = await response.json();
        
        // Remove loading message and add AI response
        removeMessage(loadingId);
        addMessageToChat('ai', data.choices[0].message.content);
    });

    // Add clear input functionality
    getEl('clear-ai-input').addEventListener('click', () => {
        getEl('ai-question').value = '';
    });

    // Add enter key support
    getEl('ai-question').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            getEl('ask-ai-btn').click();
        }
    });

    // Add quick question buttons functionality
    document.querySelectorAll('.quick-question-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            getEl('ai-question').value = btn.dataset.question;
            getEl('ask-ai-btn').click();
        });
    });

    function addMessageToChat(role, content, isLoading = false) {
        const messagesContainer = getEl('chat-messages');
        const messageDiv = document.createElement('div');
        const messageId = 'msg-' + Date.now();
        messageDiv.id = messageId;
        messageDiv.className = `chat-message ${role}-message ${isLoading ? 'opacity-50' : ''}`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (isLoading) {
            contentDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
        } else {
            contentDiv.textContent = content;
        }
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(timeDiv);
        messagesContainer.appendChild(messageDiv);
        
        // Scroll to bottom with smooth animation
        messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
        });
        
        return messageId;
    }

    function removeMessage(messageId) {
        const message = document.getElementById(messageId);
        if (message) {
            message.remove();
        }
    }

    const analyzeUserData = (startDate, endDate) => {
        const workoutData = {
            exercises: {},
            categories: {},
            progression: {},
            frequency: {},
            totalVolume: 0,
            totalWorkouts: 0,
            caloriesBurned: 0,
            recentPRs: [],
            workoutStreak: 0,
            bestExercises: [],
            muscleBalance: {},
            workoutConsistency: {
                daysPerWeek: 0,
                averageSetsPerWorkout: 0,
                averageRepsPerWorkout: 0
            }
        };
        
        const nutritionData = {
            totalCalories: 0,
            totalProtein: 0,
            averageCalories: 0,
            averageProtein: 0,
            daysTracked: 0,
            commonFoods: {},
            nutritionStreak: 0,
            nutritionConsistency: {
                daysPerWeek: 0,
                averageMealsPerDay: 0
            }
        };
        
        let currentDate = new Date(startDate);
        let lastWorkoutDate = null;
        let lastNutritionDate = null;
        let currentWorkoutStreak = 0;
        let currentNutritionStreak = 0;
        
        while (currentDate <= endDate) {
            const dayString = currentDate.toISOString().split('T')[0];
            
            // Analyze workouts
            if (state.workouts && state.workouts[dayString]) {
                workoutData.totalWorkouts++;
                let dailySets = 0;
                let dailyReps = 0;
                
                state.workouts[dayString].forEach(w => {
                    const volume = Number(w.reps) * Number(w.weight);
                    workoutData.totalVolume += volume;
                    workoutData.caloriesBurned += calculateCaloriesBurned(w);
                    dailySets += Number(w.sets);
                    dailyReps += Number(w.reps);
                    
                    // Track exercise data
                    if (!workoutData.exercises[w.name]) {
                        workoutData.exercises[w.name] = {
                            totalVolume: 0,
                            maxWeight: 0,
                            frequency: 0,
                            progression: [],
                            lastPR: null
                        };
                    }
                    workoutData.exercises[w.name].totalVolume += volume;
                    workoutData.exercises[w.name].maxWeight = Math.max(workoutData.exercises[w.name].maxWeight, Number(w.weight));
                    workoutData.exercises[w.name].frequency++;
                    workoutData.exercises[w.name].progression.push({
                        date: dayString,
                        weight: Number(w.weight),
                        volume: volume
                    });
                    
                    // Check for PR
                    if (Number(w.weight) > workoutData.exercises[w.name].maxWeight) {
                        workoutData.exercises[w.name].lastPR = {
                            date: dayString,
                            weight: Number(w.weight)
                        };
                        workoutData.recentPRs.push({
                            exercise: w.name,
                            weight: Number(w.weight),
                            date: dayString
                        });
                    }
                    
                    // Track category data
                    if (!workoutData.categories[w.category]) {
                        workoutData.categories[w.category] = {
                            totalVolume: 0,
                            frequency: 0,
                            exercises: new Set()
                        };
                    }
                    workoutData.categories[w.category].totalVolume += volume;
                    workoutData.categories[w.category].frequency++;
                    workoutData.categories[w.category].exercises.add(w.name);
                });
                
                // Update workout streak
                if (lastWorkoutDate) {
                    const daysSinceLastWorkout = Math.floor((currentDate - lastWorkoutDate) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastWorkout === 1) {
                        currentWorkoutStreak++;
                    } else {
                        currentWorkoutStreak = 1;
                    }
                } else {
                    currentWorkoutStreak = 1;
                }
                workoutData.workoutStreak = Math.max(workoutData.workoutStreak, currentWorkoutStreak);
                lastWorkoutDate = new Date(currentDate);
            }
            
            // Analyze nutrition
            if (state.food && state.food[dayString]) {
                nutritionData.daysTracked++;
                const mealsToday = state.food[dayString].length;
                nutritionData.nutritionConsistency.averageMealsPerDay += mealsToday;
                
                state.food[dayString].forEach(f => {
                    const calories = f.calories * f.quantity;
                    const protein = f.protein * f.quantity;
                    nutritionData.totalCalories += calories;
                    nutritionData.totalProtein += protein;
                    
                    // Track common foods
                    if (!nutritionData.commonFoods[f.name]) {
                        nutritionData.commonFoods[f.name] = {
                            frequency: 0,
                            totalCalories: 0,
                            totalProtein: 0
                        };
                    }
                    nutritionData.commonFoods[f.name].frequency++;
                    nutritionData.commonFoods[f.name].totalCalories += calories;
                    nutritionData.commonFoods[f.name].totalProtein += protein;
                });
                
                // Update nutrition streak
                if (lastNutritionDate) {
                    const daysSinceLastNutrition = Math.floor((currentDate - lastNutritionDate) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastNutrition === 1) {
                        currentNutritionStreak++;
                    } else {
                        currentNutritionStreak = 1;
                    }
                } else {
                    currentNutritionStreak = 1;
                }
                nutritionData.nutritionStreak = Math.max(nutritionData.nutritionStreak, currentNutritionStreak);
                lastNutritionDate = new Date(currentDate);
            }
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Calculate averages and finalize data
        const daysInRange = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        nutritionData.averageCalories = nutritionData.totalCalories / daysInRange;
        nutritionData.averageProtein = nutritionData.totalProtein / daysInRange;
        nutritionData.nutritionConsistency.daysPerWeek = (nutritionData.daysTracked / daysInRange) * 7;
        nutritionData.nutritionConsistency.averageMealsPerDay /= nutritionData.daysTracked;
        
        // Sort and limit recent PRs
        workoutData.recentPRs.sort((a, b) => new Date(b.date) - new Date(a.date));
        workoutData.recentPRs = workoutData.recentPRs.slice(0, 5);
        
        // Calculate muscle balance
        const totalVolume = Object.values(workoutData.categories).reduce((sum, cat) => sum + cat.totalVolume, 0);
        Object.entries(workoutData.categories).forEach(([category, data]) => {
            workoutData.muscleBalance[category] = {
                percentage: (data.totalVolume / totalVolume) * 100,
                exercises: Array.from(data.exercises)
            };
        });
        
        // Calculate workout consistency
        workoutData.workoutConsistency.daysPerWeek = (workoutData.totalWorkouts / daysInRange) * 7;
        
        // Sort common foods by frequency
        nutritionData.commonFoods = Object.entries(nutritionData.commonFoods)
            .sort(([, a], [, b]) => b.frequency - a.frequency)
            .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {});
        
        return {
            workoutData,
            nutritionData,
            dateRange: {
                start: startDate.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            }
        };
    };

    // AI Helper Modal Logic
    aiHelperMenuBtn.addEventListener('click', () => {
        // Clear all messages except the welcome message
        const messages = aiHelperModalMessages.children;
        while (messages.length > 1) {
            aiHelperModalMessages.removeChild(messages[1]);
        }
        // Show welcome message if it's hidden
        aiHelperWelcome.style.display = 'flex';
        // Clear input
        aiHelperModalInput.value = '';
        
        // Show modal
        aiHelperModal.classList.add('active');
        aiHelperModal.style.display = 'flex';
        setTimeout(() => aiHelperModalInput.focus(), 200);
    });
    closeAiHelperModal.addEventListener('click', () => {
        aiHelperModal.classList.remove('active');
        aiHelperModal.style.display = 'none';
    });

    // Add New Chat functionality
    getEl('new-chat-btn').addEventListener('click', () => {
        // Clear all messages except the welcome message
        const messages = aiHelperModalMessages.children;
        while (messages.length > 1) {
            aiHelperModalMessages.removeChild(messages[1]);
        }
        // Show welcome message if it's hidden
        aiHelperWelcome.style.display = 'flex';
        // Clear input
        aiHelperModalInput.value = '';
        // Focus input
        aiHelperModalInput.focus();
    });

    function addModalMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}-message`;
        messageDiv.innerHTML = `
            <div class="message-content">
                ${content}
            </div>
        `;
        aiHelperModalMessages.appendChild(messageDiv);
        aiHelperModalMessages.scrollTop = aiHelperModalMessages.scrollHeight;
    }

    aiHelperModalSend.addEventListener('click', async () => {
        const question = aiHelperModalInput.value.trim();
        if (!question) return;
        addModalMessage('user', question);
        aiHelperModalInput.value = '';
        // Show loading/typing indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'chat-message ai-message';
        loadingDiv.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
        aiHelperModalMessages.appendChild(loadingDiv);
        aiHelperModalMessages.scrollTop = aiHelperModalMessages.scrollHeight;
        try {
            // Gather user data for the last 7 days
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 6);
            const userData = analyzeUserData(startDate, today);
            
            // Create a new object with the user data to avoid readonly property issues
            const userDataCopy = JSON.parse(JSON.stringify(userData));
            
            // Call AI API with user data
            const response = await fetch('https://ai-proxy-git-main-daniels-projects-dce54a5d.vercel.app/api/openai', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: [
                        {
                            role: 'system',
                            content: `You are a fitness AI assistant. Be direct and concise in your responses. Use the following user data to provide brief, actionable insights:

User Data (last 7 days):
${JSON.stringify(userDataCopy, null, 2)}

Guidelines for responses:
1. Keep responses under 2-3 sentences
2. Focus on key metrics and actionable advice
3. Use bullet points for multiple points
4. Avoid unnecessary explanations
5. Be direct and to the point
6. Use numbers and specific data when relevant
7. No small talk or lengthy introductions
8. No repetitive information
9. No unnecessary context
10. Get straight to the point

Example good response:
"Your average daily protein is 120g, below your 150g goal. Increase protein-rich foods like chicken breast and Greek yogurt to meet your target."

Example bad response:
"Looking at your nutrition data over the past week, I notice that your protein intake has been consistently below your target. This is important because protein helps with muscle recovery and growth. I would recommend trying to incorporate more protein-rich foods into your diet, such as chicken breast, which is a great source of lean protein, and Greek yogurt, which is also high in protein and can be a good snack option."`
                        },
                        { role: 'user', content: question }
                    ]
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`API request failed with status ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                console.error('Invalid API Response:', data);
                throw new Error('Invalid response format from API');
            }

            loadingDiv.remove();
            addModalMessage('ai', data.choices[0].message.content);
        } catch (error) {
            console.error('AI Helper Error:', error);
            loadingDiv.remove();
            addModalMessage('ai', `Error: ${error.message}. Please try again.`);
        }
    });
    aiHelperModalInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') aiHelperModalSend.click();
    });

    // Add clear input functionality for AI helper modal
    const clearAiHelperInput = getEl('clear-ai-helper-input');
    aiHelperModalInput.addEventListener('input', () => {
        clearAiHelperInput.classList.toggle('hidden', !aiHelperModalInput.value);
        clearAiHelperInput.style.pointerEvents = aiHelperModalInput.value ? 'auto' : 'none';
    });
    clearAiHelperInput.addEventListener('click', () => {
        aiHelperModalInput.value = '';
        clearAiHelperInput.classList.add('hidden');
        clearAiHelperInput.style.pointerEvents = 'none';
        aiHelperModalInput.focus();
    });

    // Add event listeners for goals forms
    getEl('nutrition-goals-form').addEventListener('submit', (e) => {
        e.preventDefault();
        state.goals.nutrition = {
            calorieGoal: parseInt(getEl('calorie-goal').value) || 2000,
            proteinGoal: parseInt(getEl('protein-goal').value) || 150
        };
        saveData();
        updateGoalsProgress();

        // Update button states
        const saveBtn = getEl('save-nutrition-goals');
        const editBtn = getEl('edit-nutrition-goals');
        const inputs = [getEl('calorie-goal'), getEl('protein-goal')];

        // Disable inputs and show edit button
        inputs.forEach(input => input.disabled = true);
        saveBtn.textContent = 'Saved';
        saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        editBtn.classList.remove('hidden');
    });

    // Add edit button functionality
    getEl('edit-nutrition-goals').addEventListener('click', function() {
        const inputs = [getEl('calorie-goal'), getEl('protein-goal')];
        const saveBtn = getEl('save-nutrition-goals');
        const editBtn = getEl('edit-nutrition-goals');
        
        // Enable inputs
        inputs.forEach(input => input.disabled = false);
        
        // Update button states
        saveBtn.textContent = 'Save Nutrition Goals';
        saveBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        editBtn.classList.add('hidden');
    });

    // Initialize goals form values
    getEl('calorie-goal').value = state.goals.nutrition.calorieGoal;
    getEl('protein-goal').value = state.goals.nutrition.proteinGoal;

    function updateGoalsProgress() {
        const { startDate, endDate } = getDateRange();
        let totalCalories = 0, totalProtein = 0;
        let daysWithData = 0;

        // Calculate today's progress for food section
        const today = new Date().toISOString().split('T')[0];
        let todayCalories = 0, todayProtein = 0;
        if (state.food && state.food[today]) {
            state.food[today].forEach(f => {
                todayCalories += f.calories * f.quantity;
                todayProtein += f.protein * f.quantity;
            });
        }
        
        // Update daily progress in food section
        getEl('daily-calorie-progress-text').textContent = `${Math.round(todayCalories)}/${state.goals.nutrition.calorieGoal} cal`;
        getEl('daily-protein-progress-text').textContent = `${Math.round(todayProtein)}/${state.goals.nutrition.proteinGoal}g`;
        getEl('daily-calorie-progress-bar').style.width = `${Math.min((todayCalories / state.goals.nutrition.calorieGoal) * 100, 100)}%`;
        getEl('daily-protein-progress-bar').style.width = `${Math.min((todayProtein / state.goals.nutrition.proteinGoal) * 100, 100)}%`;

        // Calculate weekly progress
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dayString = currentDate.toISOString().split('T')[0];
            
            // Calculate nutrition progress
            if (state.food && state.food[dayString]) {
                daysWithData++;
                state.food[dayString].forEach(f => {
                    totalCalories += f.calories * f.quantity;
                    totalProtein += f.protein * f.quantity;
                });
            }

            currentDate.setDate(currentDate.getDate() + 1);
        }

        // Update weekly progress in goals section
        const weeklyCalorieGoal = state.goals.nutrition.calorieGoal * 7;
        const weeklyProteinGoal = state.goals.nutrition.proteinGoal * 7;
        
        getEl('weekly-calorie-progress-text').textContent = `${Math.round(totalCalories)}/${weeklyCalorieGoal} cal`;
        getEl('weekly-protein-progress-text').textContent = `${Math.round(totalProtein)}/${weeklyProteinGoal}g`;
        getEl('weekly-calorie-progress-bar').style.width = `${Math.min((totalCalories / weeklyCalorieGoal) * 100, 100)}%`;
        getEl('weekly-protein-progress-bar').style.width = `${Math.min((totalProtein / weeklyProteinGoal) * 100, 100)}%`;
    }

    // Update progress when adding/removing food items
    function updateFoodProgress() {
        updateGoalsProgress();
    }

    // Add updateFoodProgress call to relevant functions
    const originalAddFoodItem = addFoodItem;
    addFoodItem = function() {
        originalAddFoodItem();
        updateFoodProgress();
    };

    const originalRemoveFoodItem = removeFoodItem;
    removeFoodItem = function() {
        originalRemoveFoodItem();
        updateFoodProgress();
    };

    // Update the save nutrition goals button handler
    document.getElementById('save-nutrition-goals').addEventListener('click', function() {
        const calorieGoal = parseInt(document.getElementById('calorie-goal').value) || 0;
        const proteinGoal = parseInt(document.getElementById('protein-goal').value) || 0;
        
        if (calorieGoal > 0 && proteinGoal > 0) {
            state.goals = {
                ...state.goals,
                nutrition: {
                    calories: calorieGoal,
                    protein: proteinGoal
                }
            };
            localStorage.setItem('goals', JSON.stringify(state.goals));
            updateGoalsProgress();
            
            // Disable inputs after saving
            getEl('calorie-goal').disabled = true;
            getEl('protein-goal').disabled = true;
            
            // Update button states
            this.textContent = 'Saved';
            this.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            this.classList.add('bg-gray-600', 'hover:bg-gray-700');
            getEl('edit-nutrition-goals').classList.remove('hidden');
        } else {
            alert('Please enter valid goals for both calories and protein');
        }
    });

    // Check saved state on page load
    if (localStorage.getItem('goalsSaved') === 'true') {
        const saveBtn = document.getElementById('save-nutrition-goals');
        saveBtn.textContent = 'Saved';
        saveBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        saveBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
    }

    // Theme switching
    themeOptions.forEach(option => {
        option.addEventListener('click', () => {
            const theme = option.dataset.theme;
            document.documentElement.classList.remove('light', 'dark');
            document.documentElement.classList.add(theme);
            localStorage.setItem('theme', theme);
            
            // Update active state
            themeOptions.forEach(opt => opt.classList.remove('ring-2', 'ring-blue-500'));
            option.classList.add('ring-2', 'ring-blue-500');
        });
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.classList.add(savedTheme);
    const activeThemeOption = document.querySelector(`.theme-option[data-theme="${savedTheme}"]`);
    if (activeThemeOption) {
        activeThemeOption.classList.add('ring-2', 'ring-blue-500');
    }

    // Load saved notification preferences
    const savedPreferences = JSON.parse(localStorage.getItem('notificationPreferences') || '{}');
    workoutReminders.checked = savedPreferences.workoutReminders || false;
    nutritionReminders.checked = savedPreferences.nutritionReminders || false;

    // Save notification preferences
    workoutReminders.addEventListener('change', () => {
        const preferences = JSON.parse(localStorage.getItem('notificationPreferences') || '{}');
        preferences.workoutReminders = workoutReminders.checked;
        localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
    });

    nutritionReminders.addEventListener('change', () => {
        const preferences = JSON.parse(localStorage.getItem('notificationPreferences') || '{}');
        preferences.nutritionReminders = nutritionReminders.checked;
        localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
    });

    // Data management
    exportDataBtn.addEventListener('click', () => {
        const data = {
            workouts: state.workouts,
            food: state.food,
            favorites: state.favorites,
            goals: state.goals,
            settings: {
                theme: localStorage.getItem('theme'),
                notificationPreferences: JSON.parse(localStorage.getItem('notificationPreferences') || '{}')
            }
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `phat-and-fit-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    importDataBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Validate data structure
                        if (!data.workouts || !data.food || !data.favorites || !data.goals) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        // Restore data
                        state.workouts = data.workouts;
                        state.food = data.food;
                        state.favorites = data.favorites;
                        state.goals = data.goals;
                        
                        // Restore settings
                        if (data.settings) {
                            if (data.settings.theme) {
                                localStorage.setItem('theme', data.settings.theme);
                                document.documentElement.classList.remove('light', 'dark');
                                document.documentElement.classList.add(data.settings.theme);
                            }
                            if (data.settings.notificationPreferences) {
                                localStorage.setItem('notificationPreferences', JSON.stringify(data.settings.notificationPreferences));
                                workoutReminders.checked = data.settings.notificationPreferences.workoutReminders || false;
                                nutritionReminders.checked = data.settings.notificationPreferences.nutritionReminders || false;
                            }
                        }
                        
                        saveData();
                        renderAll();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        };
        
        input.click();
    });

    clearDataBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
            // Clear all data
            state.workouts = {};
            state.food = {};
            state.favorites = {};
            state.goals = {
                nutrition: {
                    calorieGoal: 2000,
                    proteinGoal: 150
                }
            };
            
            // Clear localStorage
            localStorage.clear();
            
            // Reset settings
            document.documentElement.classList.remove('light', 'dark');
            document.documentElement.classList.add('light');
            localStorage.setItem('theme', 'light');
            
            // Reset notification preferences
            workoutReminders.checked = false;
            nutritionReminders.checked = false;
            localStorage.setItem('notificationPreferences', JSON.stringify({
                workoutReminders: false,
                nutritionReminders: false
            }));
            
            saveData();
            renderAll();
            alert('All data has been cleared.');
        }
    });
});
</script>

</body>
</html>
